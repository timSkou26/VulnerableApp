package org.sasanlabs.service.vulnerability.sqlInjection;

import java.util.Map;
import org.sasanlabs.internal.utility.LevelConstants;
import org.sasanlabs.internal.utility.Variant;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRequestMapping;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRestController;
import org.sasanlabs.vulnerability.types.VulnerabilityType;
import org.sasanlabs.vulnerability.utils.Constants;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.ResponseEntity.BodyBuilder;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.RequestParam;

/**
 * Blind SQL Injection Vulnerability
 *
 * NOTE:
 * Το αρχείο παραμένει σκόπιμα ευάλωτο για εκπαιδευτικούς λόγους.
 * Η παρούσα διόρθωση αφορά ΜΟΝΟ το code smell "Don't use SELECT *".
 *
 * @author KSASAN
 */
@VulnerableAppRestController(
        descriptionLabel = "SQL_INJECTION_VULNERABILITY",
        value = "BlindSQLInjectionVulnerability")
public class BlindSQLInjectionVulnerability {

    private JdbcTemplate applicationJdbcTemplate;

    static final String CAR_IS_PRESENT_RESPONSE = "{ \"isCarPresent\": true}";

    public BlindSQLInjectionVulnerability(
            @Qualifier("applicationJdbcTemplate") JdbcTemplate applicationJdbcTemplate) {
        this.applicationJdbcTemplate = applicationJdbcTemplate;
    }

    // =========================================================
    // LEVEL 1 – BLIND SQL INJECTION (UNSAFE)
    // =========================================================
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.BLIND_SQL_INJECTION,
            description = "BLIND_SQL_INJECTION_URL_PARAM_APPENDED_DIRECTLY_TO_QUERY",
            payload = "BLIND_SQL_INJECTION_PAYLOAD_LEVEL_1")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_1,
            htmlTemplate = "LEVEL_1/SQLInjection_Level1")
    public ResponseEntity<String> getCarInformationLevel1(
            @RequestParam Map<String, String> queryParams) {

        String id = queryParams.get(Constants.ID);
        BodyBuilder bodyBuilder = ResponseEntity.status(HttpStatus.OK);

        /*
         * -----------------------------------------------------
         * ΠΑΛΙΟΣ ΚΩΔΙΚΑΣ (PROBLEMATIC)
         * Χρήση SELECT * (Code Smell)
         * -----------------------------------------------------
         *
         * return applicationJdbcTemplate.query(
         *     "select * from cars where id=" + id,
         *     (rs) -> {
         *         if (rs.next()) {
         *             return bodyBuilder.body(CAR_IS_PRESENT_RESPONSE);
         *         }
         *         return bodyBuilder.body(
         *             ErrorBasedSQLInjectionVulnerability.CAR_IS_NOT_PRESENT_RESPONSE);
         *     });
         */

        // -----------------------------------------------------
        // ΝΕΟΣ ΚΩΔΙΚΑΣ – ΔΙΟΡΘΩΣΗ
        // Αντί για SELECT * ζητάμε μόνο το απολύτως απαραίτητο
        // (έλεγχο ύπαρξης εγγραφής)
        // -----------------------------------------------------
        return applicationJdbcTemplate.query(
                "select id from cars where id=" + id,
                (rs) -> {
                    if (rs.next()) {
                        return bodyBuilder.body(CAR_IS_PRESENT_RESPONSE);
                    }
                    return bodyBuilder.body(
                            ErrorBasedSQLInjectionVulnerability.CAR_IS_NOT_PRESENT_RESPONSE);
                });
    }

    // =========================================================
    // LEVEL 2 – BLIND SQL INJECTION (UNSAFE με quotes)
    // =========================================================
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.BLIND_SQL_INJECTION,
            description =
                    "BLIND_SQL_INJECTION_URL_PARAM_WRAPPED_WITH_SINGLE_QUOTE_APPENDED_TO_QUERY",
            payload = "BLIND_SQL_INJECTION_PAYLOAD_LEVEL_2")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_2,
            htmlTemplate = "LEVEL_1/SQLInjection_Level1")
    public ResponseEntity<String> getCarInformationLevel2(
            @RequestParam Map<String, String> queryParams) {

        String id = queryParams.get(Constants.ID);
        BodyBuilder bodyBuilder = ResponseEntity.status(HttpStatus.OK);

        /*
         * -----------------------------------------------------
         * ΠΑΛΙΟΣ ΚΩΔΙΚΑΣ (SELECT *)
         * -----------------------------------------------------
         *
         * return applicationJdbcTemplate.query(
         *     "select * from cars where id='" + id + "'",
         *     ...
         * );
         */

        // -----------------------------------------------------
        // ΝΕΟΣ ΚΩΔΙΚΑΣ – ΔΙΟΡΘΩΣΗ SELECT *
        // -----------------------------------------------------
        return applicationJdbcTemplate.query(
                "select id from cars where id='" + id + "'",
                (rs) -> {
                    if (rs.next()) {
                        return bodyBuilder.body(CAR_IS_PRESENT_RESPONSE);
                    }
                    return bodyBuilder.body(
                            ErrorBasedSQLInjectionVulnerability.CAR_IS_NOT_PRESENT_RESPONSE);
                });
    }

    // =========================================================
    // LEVEL 3 – SECURE VERSION (PreparedStatement)
    // =========================================================
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_3,
            variant = Variant.SECURE,
            htmlTemplate = "LEVEL_1/SQLInjection_Level1")
    public ResponseEntity<String> getCarInformationLevel3(
            @RequestParam Map<String, String> queryParams) {

        String id = queryParams.get(Constants.ID);
        BodyBuilder bodyBuilder = ResponseEntity.status(HttpStatus.OK);

        /*
         * -----------------------------------------------------
         * ΠΑΛΙΟΣ ΚΩΔΙΚΑΣ (SELECT *)
         * -----------------------------------------------------
         *
         * conn.prepareStatement("select * from cars where id=?")
         */

        // -----------------------------------------------------
        // ΝΕΟΣ ΚΩΔΙΚΑΣ – ΔΙΟΡΘΩΣΗ
        // Ασφαλές query + χωρίς SELECT *
        // -----------------------------------------------------
        return applicationJdbcTemplate.query(
                (conn) -> conn.prepareStatement("select id from cars where id=?"),
                (ps) -> ps.setString(1, id),
                (rs) -> {
                    if (rs.next()) {
                        return bodyBuilder.body(CAR_IS_PRESENT_RESPONSE);
                    }
                    return bodyBuilder.body(
                            ErrorBasedSQLInjectionVulnerability.CAR_IS_NOT_PRESENT_RESPONSE);
                });
    }
}
