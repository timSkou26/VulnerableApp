package org.sasanlabs.service.vulnerability.sqlInjection;

import com.fasterxml.jackson.core.JsonProcessingException;
import java.util.Map;

import org.sasanlabs.internal.utility.LevelConstants;
import org.sasanlabs.internal.utility.annotations.AttackVector;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRequestMapping;
import org.sasanlabs.internal.utility.annotations.VulnerableAppRestController;

import org.sasanlabs.service.vulnerability.sqlInjection.data.CarInformation;
import org.sasanlabs.vulnerability.utils.Constants;
import org.sasanlabs.vulnerability.utils.JSONSerializationUtils;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.http.ResponseEntity.BodyBuilder;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.web.bind.annotation.RequestParam;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@VulnerableAppRestController(
        descriptionLabel = "ERROR_BASED_SQL_INJECTION_VULNERABILITY",
        value = "ErrorBasedSQLInjection")
public class ErrorBasedSQLInjectionVulnerability {

    private static final Logger LOGGER =
            LoggerFactory.getLogger(ErrorBasedSQLInjectionVulnerability.class);

    @Autowired 
    private JdbcTemplate applicationJdbcTemplate;

    private static final java.util.function.Function<CarInformation, String> 
            CAR_IS_PRESENT_RESPONSE = (carInfo) -> "Car Present: " + carInfo;

    private static final java.util.function.Function<Exception, String>
            GENERIC_EXCEPTION_RESPONSE_FUNCTION =
                    (ex) -> "Exception occurred: " + ex.getMessage();

    private static final String CAR_IS_NOT_PRESENT_RESPONSE = "Car Not Found";


    // ================================================================
    // LEVEL 1 — FIXED VERSION
    // ================================================================
    @AttackVector(
            vulnerabilityExposed = VulnerabilityType.ERROR_BASED_SQL_INJECTION,
            payload = "ERROR_BASED_SQL_INJECTION_PAYLOAD_LEVEL_1")
    @VulnerableAppRequestMapping(
            value = LevelConstants.LEVEL_1,
            htmlTemplate = "LEVEL_1/SQLInjection_Level1")
    public ResponseEntity<String> doesCarInformationExistsLevel1(
            @RequestParam Map<String, String> queryParams) {

        String id = queryParams.get(Constants.ID);
        BodyBuilder bodyBuilder = ResponseEntity.status(HttpStatus.OK);

        try {

            // ---------------------------------------------------------------
            // ❌ ΠΑΛΙΟΣ ΕΠΙΚΙΝΔΥΝΟΣ ΚΩΔΙΚΑΣ (SQL INJECTION VULNERABILITY)
            // ---------------------------------------------------------------
            /*
            ResponseEntity<String> response =
                applicationJdbcTemplate.query(
                    "select * from cars where id=" + id,   // <-- UNSAFE !!!
                    (rs) -> {
                        if (rs.next()) {
                            CarInformation carInformation = new CarInformation();
                            carInformation.setId(rs.getInt(1));
                            carInformation.setName(rs.getString(2));
                            carInformation.setImagePath(rs.getString(3));
                            try {
                                return bodyBuilder.body(
                                        CAR_IS_PRESENT_RESPONSE.apply(
                                                JSONSerializationUtils.serialize(
                                                        carInformation)));
                            } catch (JsonProcessingException e) {
                                LOGGER.error("Error", e);
                                return bodyBuilder.body(
                                        GENERIC_EXCEPTION_RESPONSE_FUNCTION.apply(e));
                            }
                        } else {
                            return bodyBuilder.body(CAR_IS_NOT_PRESENT_RESPONSE);
                        }
                    });
            return response;
            */


            // ---------------------------------------------------------------
            // ✅ ΔΙΟΡΘΩΜΕΝΟΣ ΑΣΦΑΛΗΣ ΚΩΔΙΚΑΣ
            // Χρησιμοποιούμε parameterized query με placeholder: ?
            // Έτσι το id ΔΕΝ μπορεί να εκτελέσει SQL Injection.
            // ---------------------------------------------------------------
            String sql = "SELECT * FROM cars WHERE id = ?";

            ResponseEntity<String> response =
                applicationJdbcTemplate.query(
                        sql,
                        new Object[]{id},     // <-- SECURE PARAMETER BINDING
                        (rs) -> {
                            if (rs.next()) {
                                CarInformation carInformation = new CarInformation();
                                carInformation.setId(rs.getInt(1));
                                carInformation.setName(rs.getString(2));
                                carInformation.setImagePath(rs.getString(3));

                                try {
                                    return bodyBuilder.body(
                                            CAR_IS_PRESENT_RESPONSE.apply(
                                                    JSONSerializationUtils.serialize(
                                                            carInformation)));
                                } catch (JsonProcessingException e) {
                                    LOGGER.error("Following error occurred", e);
                                    return bodyBuilder.body(
                                            GENERIC_EXCEPTION_RESPONSE_FUNCTION.apply(e));
                                }
                            } else {
                                return bodyBuilder.body(CAR_IS_NOT_PRESENT_RESPONSE);
                            }
                        }
                );

            return response;

        } catch (Exception ex) {
            LOGGER.error("Following error occurred", ex);
            return bodyBuilder.body(GENERIC_EXCEPTION_RESPONSE_FUNCTION.apply(ex));
        }
    }
}
